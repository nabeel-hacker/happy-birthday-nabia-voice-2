<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Blow the Candles ‚Äî Happy Birthday Nabia</title>
<style>
  :root{--bg1:#ffecd2;--bg2:#fcb69f;--accent:#ff2d7a}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto; background:linear-gradient(160deg,var(--bg1),var(--bg2));}
  .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px;box-sizing:border-box;}
  .card{width:100%;max-width:820px;background:rgba(255,255,255,0.93);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,0.12);padding:28px;position:relative;overflow:hidden;text-align:center;}
  h1{margin:6px 0 4px;font-size:2rem;color:#333}
  p.lead{margin:6px 0 18px;color:#555;font-size:1rem}
  .controls{display:flex;gap:12px;justify-content:center;margin-top:16px}
  button{background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:999px;font-weight:600;cursor:pointer;box-shadow:0 6px 16px rgba(255,45,122,0.18);}
  button.secondary{background:#fff;color:var(--accent);border:1px solid rgba(0,0,0,0.06)}
  /* Cake */
  .stage{display:flex;flex-direction:column;align-items:center;gap:14px}
  .cake{
    width:320px;height:220px;position:relative;
    display:flex;align-items:center;justify-content:center;flex-direction:column;
  }
  .plate{width:360px;height:18px;background:#fff;border-radius:50%;box-shadow:inset 0 -8px 18px rgba(0,0,0,0.06);position:relative;top:26px}
  .tier{width:280px;height:120px;background:linear-gradient(180deg,#fffbf7,#fff);border-radius:12px;position:relative;z-index:2;box-shadow:0 8px 18px rgba(0,0,0,0.06)}
  .icing{position:absolute;top:-6px;left:10px;right:10px;height:36px;background:linear-gradient(90deg,#ffd0ea,#ffb3d5);border-radius:18px 18px 12px 12px;box-shadow:inset 0 -6px rgba(255,255,255,0.25)}
  /* Candles group */
  .candles{position:absolute;top:-24px;display:flex;gap:14px;transform:translateY(-8px)}
  .candle{width:12px;height:46px;background:#fff;border-radius:4px;position:relative;display:flex;align-items:flex-start;justify-content:center;overflow:visible}
  .candle::after{content:"";position:absolute;bottom:-6px;left:50%;transform:translateX(-50%);width:18px;height:8px;background:rgba(0,0,0,0.05);border-radius:50%}
  .wax{width:100%;height:50%;background:linear-gradient(#ffdede,#ff9aa8);border-top-left-radius:3px;border-top-right-radius:3px}
  .flame{width:14px;height:18px;background:radial-gradient(circle at 35% 30%, #fff 0 6px, transparent 7px),linear-gradient(#ffeb6b,#ff8036);border-radius:50% 50% 40% 40%;position:relative;margin-top:-9px;box-shadow:0 6px 14px rgba(255,120,40,0.25);transform-origin:center bottom;animation: flicker 900ms infinite}
  .flame small{position:absolute;left:50%;top:50%;transform:translate(-50%,-40%);width:6px;height:6px;border-radius:50%;background:#fff;opacity:0.9}
  @keyframes flicker{0%{transform:scale(1) translateY(0)}50%{transform:scale(0.92) translateY(-2px)}100%{transform:scale(1) translateY(0)}}
  .flame.out{opacity:0;transform:scale(0.3);transition:all 700ms ease-out}
  /* Message after blow */
  .message{margin-top:18px;font-size:1.1rem;color:#333;min-height:36px}
  .big{font-size:1.6rem;font-weight:700;color:var(--accent);margin-top:10px}
  /* Confetti canvas */
  #confettiCanvas{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:5}
  /* mic indicator */
  .mic-box{display:inline-block;padding:8px 12px;border-radius:999px;background:#fff;border:1px dashed rgba(0,0,0,0.06);margin-top:10px;color:#444}
  /* small responsive */
  @media (max-width:420px){.cake{width:260px;height:190px}.plate{width:300px}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main">
      <canvas id="confettiCanvas"></canvas>

      <div class="stage">
        <h1>üéÇ Surprise ‚Äî Blow the candles!</h1>
        <p class="lead">Allow mic, then blow into your phone's mic to extinguish the candles for <strong>Nabia Meri Jan</strong>.</p>

        <div class="cake" aria-hidden="true">
          <div class="candles" id="candlesHolder">
            <!-- candles will be generated by JS -->
          </div>

          <div class="tier">
            <div class="icing"></div>
            <!-- decoration -->
            <div style="position:absolute;bottom:16px;color:#8b3a5a;font-weight:700">Nabia Meri Jan</div>
          </div>
          <div class="plate"></div>
        </div>

        <div class="controls">
          <button id="startBtn">Start (Allow Mic)</button>
          <button class="secondary" id="resetBtn" style="display:none">Try Again</button>
        </div>

        <div class="message" id="status">Status: Waiting</div>
        <div class="mic-box" id="micLevel">Mic: ‚è∫Ô∏è ‚Äî not active</div>
        <div class="big" id="finalText" style="display:none">üéâ Happy Birthday Nabia Meri Jan üéâ</div>
      </div>
    </div>
  </div>

<script>
/*
  Blow-to-extinguish demo
  - Copies: place this file as index.html in your repo
  - Requirements: served over HTTPS (Netlify provides that)
  - How it detects blow: measures short-time audio RMS and looks for sudden spike
*/

const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const status = document.getElementById('status');
const micLevel = document.getElementById('micLevel');
const finalText = document.getElementById('finalText');
const confettiCanvas = document.getElementById('confettiCanvas');
const candlesHolder = document.getElementById('candlesHolder');

let audioCtx, analyser, dataArray, source, mediaStream;
let detectInterval, blowing = false, extinguished = false;
const THRESHOLD = 0.08; // detection threshold (RMS) ‚Äî tweak if needed
const REQUIRED_SPIKES = 2; // number of spike events needed
let spikeCount = 0;

// create 5 candles
function makeCandles(n=5){
  candlesHolder.innerHTML='';
  for(let i=0;i<n;i++){
    const c = document.createElement('div'); c.className='candle';
    c.innerHTML = '<div class="wax"></div><div class="flame"><small></small></div>';
    candlesHolder.appendChild(c);
  }
  // center candles
  candlesHolder.style.gap = '12px';
}
makeCandles(5);

// confetti simple
function launchConfetti(){
  const canvas = confettiCanvas;
  const ctx = canvas.getContext('2d');
  function resize(){ canvas.width = canvas.clientWidth * devicePixelRatio; canvas.height = canvas.clientHeight * devicePixelRatio; ctx.scale(devicePixelRatio, devicePixelRatio); }
  resize(); window.addEventListener('resize', resize);
  const pieces=[];
  for(let i=0;i<120;i++){
    pieces.push({
      x: Math.random()*canvas.clientWidth,
      y: -Math.random()*200,
      r: Math.random()*8+4,
      vx: (Math.random()-0.5)*3,
      vy: Math.random()*4+2,
      color: `hsl(${Math.random()*360},70%,60%)`
    });
  }
  let t=0;
  function draw(){
    ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
    for(const p of pieces){
      p.x += p.vx; p.y += p.vy; p.vy += 0.02;
      ctx.fillStyle = p.color;
      ctx.beginPath();
      ctx.ellipse(p.x, p.y, p.r, p.r*0.6, 0, 0, Math.PI*2);
      ctx.fill();
    }
    requestAnimationFrame(draw);
  }
  draw();
}

// extinguish animation
function extinguishCandles(){
  if(extinguished) return;
  extinguished = true;
  // fade each flame
  document.querySelectorAll('.flame').forEach((f, idx)=>{
    setTimeout(()=> f.classList.add('out'), idx*120);
  });
  // show final text & confetti after small delay
  setTimeout(()=> {
    finalText.style.display = 'block';
    launchConfetti();
    status.innerText = 'Candle(s) blown out! üéâ';
    resetBtn.style.display = 'inline-block';
  }, 800 + 200);
}

// microphone & detection
async function startMicDetection(){
  try{
    status.innerText = 'Requesting microphone...';
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    source = audioCtx.createMediaStreamSource(mediaStream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    const bufferLength = analyser.fftSize;
    dataArray = new Float32Array(bufferLength);
    source.connect(analyser);

    status.innerText = 'Blow into the mic now ‚Äî try a gentle but clear blow!';
    micLevel.innerText = 'Mic: active ‚Äî waiting for blow...';
    spikeCount = 0;
    extinguished = false;
    finalText.style.display = 'none';
    resetBtn.style.display = 'none';

    // sampling loop
    let lastRMS = 0;
    detectInterval = setInterval(()=>{
      analyser.getFloatTimeDomainData(dataArray);
      // compute RMS
      let sum = 0;
      for(let i=0;i<dataArray.length;i++){ const v=dataArray[i]; sum += v*v; }
      const rms = Math.sqrt(sum / dataArray.length);
      micLevel.innerText = `Mic RMS: ${rms.toFixed(3)}`;

      // detect rapid increase (spike)
      if(rms > THRESHOLD && (rms - lastRMS) > 0.02){
        spikeCount++;
        status.innerText = `Detected blow attempt ${spikeCount}/${REQUIRED_SPIKES} ‚Äî keep going!`;
      }

      // if enough spikes within time -> extinguish
      if(spikeCount >= REQUIRED_SPIKES && !extinguished){
        extinguishCandles();
        clearInterval(detectInterval);
        // stop mic tracks to free mic
        try{ mediaStream.getTracks().forEach(t=>t.stop()); }catch(e){}
      }
      lastRMS = rms;
    }, 120);

  }catch(err){
    console.error(err);
    status.innerText = 'Microphone access denied or not available. Please allow microphone and try again.';
    micLevel.innerText = 'Mic: not active';
  }
}

// stop detection & cleanup
function stopDetection(){
  clearInterval(detectInterval);
  try{ if(mediaStream) mediaStream.getTracks().forEach(t=>t.stop()); }catch(e){}
  if(audioCtx && audioCtx.state !== 'closed'){ try{ audioCtx.close(); }catch(_){} }
  micLevel.innerText = 'Mic: stopped';
}

startBtn.addEventListener('click', ()=>{
  // If already extinguished, reset instead
  if(extinguished){ location.reload(); return; }
  startBtn.disabled = true;
  startBtn.innerText = 'Allowing mic...';
  setTimeout(()=> startBtn.innerText = 'Listening...', 600);
  startMicDetection();
});

// reset
resetBtn.addEventListener('click', ()=>{
  stopDetection();
  // restore flames
  document.querySelectorAll('.flame').forEach(f=>f.classList.remove('out'));
  extinguished = false; spikeCount = 0;
  finalText.style.display = 'none';
  status.innerText = 'Waiting';
  micLevel.innerText = 'Mic: not active';
});

// initial candle creation
(function placeCandles(){
  const n = 5;
  // remove existing and create correct spacing
  candlesHolder.style.gap = '14px';
  candlesHolder.innerHTML = '';
  for(let i=0;i<n;i++){
    const c = document.createElement('div');
    c.className = 'candle';
    c.innerHTML = '<div class="wax"></div><div class="flame"><small></small></div>';
    candlesHolder.appendChild(c);
  }
})();
</script>
</body>
</html>
